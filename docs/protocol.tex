%% LyX 2.0.3 created this file.  For more info, see http://www.lyx.org/.
%% Do not edit unless you really know what you are doing.
\documentclass[12pt,english]{article}
\usepackage{mathptmx}
\renewcommand{\familydefault}{\rmdefault}
\usepackage[T1]{fontenc}
\usepackage[latin9]{inputenc}
\usepackage{geometry}
\geometry{verbose,tmargin=2cm,bmargin=2cm,lmargin=2cm,rmargin=2cm}

\makeatletter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Textclass specific LaTeX commands.
\newenvironment{lyxcode}
{\par\begin{list}{}{
\setlength{\rightmargin}{\leftmargin}
\setlength{\listparindent}{0pt}% needed for AMS classes
\raggedright
\setlength{\itemsep}{0pt}
\setlength{\parsep}{0pt}
\normalfont\ttfamily}%
 \item[]}
{\end{list}}

\makeatother

\usepackage{babel}
\begin{document}

\title{Alice Protocol}

\maketitle
\newpage{}

\tableofcontents{}

\newpage{}


\section{Introduction}

Alice acts as the connector between one or more Bob clients, a PostgreSQL
data store and one ore more PBX'es. Her main task is to get and set
data via a HTTP/JSON based protocol.


\section{The Protocol}

When data is requested (get) the search parameters are always given
as a HTTP GET query string and the result is always returned as a
JSON document. When data is inserted/updated/deleted (set) the parameters
are always given as a HTTP POST request and the confirmation returned
from Alice will always be a JSON document.

In order to access any of the interfaces, a client must first authenticate
itself. This is done using OpenID. The login interface is the only
interface that can be accessed without prior login.

All data handled by the protocol is expected to be UTF-8 encoded.
Alice does not check whether this is in fact the case, so when implementing
clients, be sure to verify that all data sent to Alice are UTF-8 encoded.

Application level errors and exceptions are returned as JSON documents.
How these are handled is entirely up to the client. HTTP level errors
are returned as normal for HTTP servers.


\section{The Same Origin Policy - CORS and JSONP}

Same Origin Policy is a security feature found in the Javascript implementation
in most browser. It prevents you from making requests to pages on
a different domain, another subdomain or through a different protocol.
The consequence of this is that you cannot query Alice from a client
on a different domain than the one used by Alice, which in some cases
can be a pain.

The solutions to this problem is something called Cross-Origin Resource
Sharing (CORS) and the JSONP standard. Both of these are supported
out of the box by jQuery and probably also by other Javascript frameworks.
The ``correct'' and preferred method to use for cross domain access
is CORS. Only use JSONP if CORS for some reason or another isn't supported
by your platform.


\section{The Data Model}

Instead of using only a relational or document based model, we've
opted for a mix. Data that is relational in nature is stored in columns
in a relational database, whereas everything else is stored in a JSON
document. When a client requests a specific type of data Alice combines
these two storage models into a final JSON document.

A benefit of this is that the client software easily can add new fields
and data structures, simply by expanding on the JSON document. If
we take the \emph{/get/contact} interface as an example, it might
return a JSON document looking like this:
\begin{lyxcode}
\{

\textquotedbl{}name\textquotedbl{}:\textquotedbl{}Arthur~Dent\textquotedbl{},

``items'':{[}''towel'',''heart~of~gold'',''dressing~gown''{]},

``emailaddress'':''arthurdent42@somewhere.unknown.org'',

``cellphone'':''555-777-888-999'',

``dislikes'':''Vogons'',

``db\_columns'':
\begin{lyxcode}
\{

\textquotedbl{}ce\_id\textquotedbl{}:1,

\textquotedbl{}ce\_name\textquotedbl{}:\textquotedbl{}Arthur~Dent\textquotedbl{},

``sip\_uri'':''sip://arthurdent.somewhere''

\}
\end{lyxcode}
\}
\end{lyxcode}
The \emph{db\_columns} JSON node is build from the actual columns
available in the relational database, in this case \emph{ce\_id},
\emph{ce\_name} and \emph{sip\_uri}. The data found in these columns
can be queried, sorted, grouped and/or joined by Alice. She is, so
to speak, aware of them. 

The other JSON nodes (\emph{name}, \emph{items}, \emph{emailaddress},
\emph{cellphone}, \emph{dislikes}) comes from the JSON document associated
with a contact entity. This is controlled 100\% by the client software.
Alice is completely oblivious as to what this document contains and
why. Things put here are only searchable by the client.

The strength of this model is that new fields can be added to a contact
entity on the fly, without needing any changes to Alice or the database.
Changes to Alice and/or the database itself is only necessary if the
new field must be searchable by Alice, for example in the case of
a new interface, where some given parameter is being used to search
for specific rows of data.

The weakness of this model is of course that a poorly designed/build
client can end up with some very bad JSON. We believe the strength
outweighs the weakness.


\section{Exceptions}

When bad things happen an exception is raised and an error JSON document
returned. These have the following format:
\begin{lyxcode}
\{

\textquotedbl{}exception\_message\textquotedbl{}:\textquotedbl{}foo\textquotedbl{},~

\textquotedbl{}exception\textquotedbl{}:\textquotedbl{}SOME.EXCEPTION\textquotedbl{},~

\textquotedbl{}message\textquotedbl{}:\textquotedbl{}bar\textquotedbl{}

\}
\end{lyxcode}
All exceptions have this format. It is entirely up to the client to
decide what to do with an exception.


\section{Getting Data}


\subsection{/get/call{[}?id=call id{]}}

This interface returns the JSON document associated with a call. If
the \emph{id} parameter is given, and the \emph{id} actually exists
in the call queue, then the specific call is returned. If the \emph{id}
parameter is not given, the call with the highest priority and age
is returned. If a call is returned it is also removed from the queue.
Example JSON document:
\begin{lyxcode}
\{~~~~~

\textquotedbl{}id\textquotedbl{}:\textquotedbl{}08yvc18eIM\textquotedbl{},~~~~~

\textquotedbl{}org\_id\textquotedbl{}:3~

\}
\end{lyxcode}
If no call is found, an empty JSON document is returned:
\begin{lyxcode}
\{\}
\end{lyxcode}

\subsection{/get/contact?ce\_id=positive integer}

This interface returns the JSON document associated with the contact
entity identified by \emph{ce\_id}. Example JSON document:
\begin{lyxcode}
\{

\textquotedbl{}name\textquotedbl{}:\textquotedbl{}Arthur~Dent\textquotedbl{},

``db\_columns'':
\begin{lyxcode}
\{

\textquotedbl{}ce\_id\textquotedbl{}:1,

\textquotedbl{}ce\_name\textquotedbl{}:\textquotedbl{}Arthur~Dent\textquotedbl{},

``sip\_uri'':''sip://arthurdent.somewhere''

\}
\end{lyxcode}
\}
\end{lyxcode}
An empty JSON document is returned if \emph{ce\_id} doesn't exist
in the database:
\begin{lyxcode}
\{\}
\end{lyxcode}

\subsection{/get/contact\_attributes?ce\_id=positive integer}

This interface returns the attributes associated with the \emph{ce\_id}
contact entity. Example JSON document:
\begin{lyxcode}
\{

\textquotedbl{}attributes\textquotedbl{}:{[}
\begin{lyxcode}
\{

\textquotedbl{}cellphone\textquotedbl{}:\textquotedbl{}555-777-888-999\textquotedbl{},~

\textquotedbl{}db\_columns\textquotedbl{}:
\begin{lyxcode}
\{

\textquotedbl{}ce\_id\textquotedbl{}:1,~

\textquotedbl{}org\_id\textquotedbl{}:1

\},~
\end{lyxcode}
\textquotedbl{}email\textquotedbl{}:\textquotedbl{}arthurdent42@somewhere.unknown.org\textquotedbl{},

\textquotedbl{}tags\textquotedbl{}:{[}
\begin{lyxcode}
\textquotedbl{}Traveller\textquotedbl{},

\textquotedbl{}Towel\textquotedbl{},

\textquotedbl{}Heart\textquotedbl{}

{]}
\end{lyxcode}
\},

\{

\textquotedbl{}phone\textquotedbl{}:\textquotedbl{}999-000-111\textquotedbl{},~

\textquotedbl{}db\_columns\textquotedbl{}:
\begin{lyxcode}
\{

\textquotedbl{}ce\_id\textquotedbl{}:1,~

\textquotedbl{}org\_id\textquotedbl{}:2

\},~
\end{lyxcode}
\textquotedbl{}email\textquotedbl{}:\textquotedbl{}some.other@email.address\textquotedbl{}

\}

{]}
\end{lyxcode}
\}


\end{lyxcode}
Note that \emph{attributes} contains an array, meaning that one contact
entity can be associated with several attribute sets. This means that
the attributes of a contact entity can change depending on the context
in which it is seen.

If there are no attributes associated with a contact entity, the following
JSON document is returned:
\begin{lyxcode}
\{

\textquotedbl{}attributes\textquotedbl{}:{[}{]}

\}
\end{lyxcode}

\subsection{/get/contact\_full?ce\_id=positive integer}

This interface returns the full data associated with \emph{ce\_id},
meaning it combines the data from \emph{/get/contact} and \emph{/get/contact\_attributes}.
Example JSON document:
\begin{lyxcode}
\{~~~~~

\textquotedbl{}attributes\textquotedbl{}:{[}~~~~~~~~~
\begin{lyxcode}
\{~~~~~~~~~~~~~

\textquotedbl{}cellphone\textquotedbl{}:\textquotedbl{}555-777-888-999\textquotedbl{},

\textquotedbl{}db\_columns\textquotedbl{}:~
\begin{lyxcode}
\{~~~~~~~~~~~~~~~~~

\textquotedbl{}ce\_id\textquotedbl{}:1,~~~~~~~~~~~~~~~~~

\textquotedbl{}org\_id\textquotedbl{}:1~~~~~~~~~~~~~

\},~~~~~~~~~~~~~
\end{lyxcode}
\textquotedbl{}email\textquotedbl{}:\textquotedbl{}arthurdent42@somewhere.unknown.org\textquotedbl{},

\textquotedbl{}tags\textquotedbl{}:{[}
\begin{lyxcode}
\textquotedbl{}Traveller\textquotedbl{},

\textquotedbl{}Towel\textquotedbl{},

\textquotedbl{}Heart\textquotedbl{}

{]}~~~~~~~~
\end{lyxcode}
\},~~~~~~~~~

\{~~~~~~~~~~~~~

\textquotedbl{}cellphone\textquotedbl{}:\textquotedbl{}333-666-111-222\textquotedbl{},~~~~~~~~~~~~~

\textquotedbl{}db\_columns\textquotedbl{}:~
\begin{lyxcode}
\{~~~~~~~~~~~~~~~~~

\textquotedbl{}ce\_id\textquotedbl{}:1,~~~~~~~~~~~~~~~~~

\textquotedbl{}org\_id\textquotedbl{}:2~~~~~~~~~~~~~

\},~~~~~~~~~~~~~
\end{lyxcode}
\textquotedbl{}email\textquotedbl{}:\textquotedbl{}some.other@email.address\textquotedbl{}

\}~~~~~

{]},~~~~~

\textquotedbl{}name\textquotedbl{}:\textquotedbl{}Arthur~Dent\textquotedbl{},~~~~~

\textquotedbl{}db\_columns\textquotedbl{}:~
\begin{lyxcode}
\{~~~~~~~~~

\textquotedbl{}is\_human\textquotedbl{}:true,~~~~~~~~~

\textquotedbl{}ce\_id\textquotedbl{}:1,~~~~~~~~~

\textquotedbl{}ce\_name\textquotedbl{}:\textquotedbl{}Arthur~Dent\textquotedbl{}~~~~~

\},~~~~~
\end{lyxcode}
\textquotedbl{}type\textquotedbl{}:\textquotedbl{}human\textquotedbl{}~
\end{lyxcode}
\}
\end{lyxcode}
An empty JSON document is returned if \emph{ce\_id} does not exist:
\begin{lyxcode}
\{\}
\end{lyxcode}

\subsection{/get/organization?org\_id=positive integer}

This interface returns the data associated with the \emph{org\_id}
organization. Example JSON:
\begin{lyxcode}
\{

\textquotedbl{}name\textquotedbl{}:\textquotedbl{}AdaHeads~K/S\textquotedbl{},~

\textquotedbl{}db\_columns\textquotedbl{}:
\begin{lyxcode}
\{

\textquotedbl{}org\_name\textquotedbl{}:\textquotedbl{}AdaHeads~K/S\textquotedbl{},~

\textquotedbl{}identifier\textquotedbl{}:\textquotedbl{}sip://adaheads\textquotedbl{},~

\textquotedbl{}org\_id\textquotedbl{}:1

\}
\end{lyxcode}
\}
\end{lyxcode}
An empty JSON document is returned if no \emph{org\_id} organization
is found in the database:
\begin{lyxcode}
\{\}
\end{lyxcode}

\subsection{/get/org\_contacts?org\_id=positive integer}

This interface returns all the contact entities associated with \emph{org\_id}.
Example JSON:
\begin{lyxcode}
\{

\textquotedbl{}contacts\textquotedbl{}:{[}
\begin{lyxcode}
\{

\textquotedbl{}name\textquotedbl{}:\textquotedbl{}Zaphod~B.\textquotedbl{},~

\textquotedbl{}db\_columns\textquotedbl{}:
\begin{lyxcode}
\{

\textquotedbl{}ce\_id\textquotedbl{}:4,~

\textquotedbl{}org\_id\textquotedbl{}:1,~

\textquotedbl{}ce\_name\textquotedbl{}:\textquotedbl{}Zaphod~B.\textquotedbl{}

\}
\end{lyxcode}
\},~

\{

\textquotedbl{}name\textquotedbl{}:\textquotedbl{}Arthur~Dent\textquotedbl{},~

\textquotedbl{}db\_columns\textquotedbl{}:
\begin{lyxcode}
\{

\textquotedbl{}ce\_id\textquotedbl{}:1,~

\textquotedbl{}org\_id\textquotedbl{}:1,~

\textquotedbl{}ce\_name\textquotedbl{}:\textquotedbl{}Arthur~Dent\textquotedbl{}

\}
\end{lyxcode}
\}

{]}
\end{lyxcode}
\}
\end{lyxcode}
The \emph{contacts} node contains an array, so it can hold multiple
contact entities. If no contact entities are associated with the given
\emph{org\_id} the following JSON document is returned:
\begin{lyxcode}
\{

\textquotedbl{}contacts\textquotedbl{}:{[}{]}

\}
\end{lyxcode}

\subsection{/get/org\_contacts\_attributes?org\_id=positive integer}

This interface returns all the contact entity attribute sets associated
with \emph{org\_id}. Example JSON document:
\begin{lyxcode}
\{

\textquotedbl{}attributes\textquotedbl{}:{[}
\begin{lyxcode}
\{

\textquotedbl{}cellphone\textquotedbl{}:\textquotedbl{}555-777-888-999\textquotedbl{},~

\textquotedbl{}db\_columns\textquotedbl{}:
\begin{lyxcode}
\{

\textquotedbl{}ce\_id\textquotedbl{}:1,~

\textquotedbl{}org\_id\textquotedbl{}:1

\},~
\end{lyxcode}
\textquotedbl{}email\textquotedbl{}:\textquotedbl{}arthurdent42@somewhere.unknown.org\textquotedbl{},

\textquotedbl{}tags\textquotedbl{}:{[}
\begin{lyxcode}
\textquotedbl{}Traveller\textquotedbl{},

\textquotedbl{}Towel\textquotedbl{},

\textquotedbl{}Heart\textquotedbl{}

{]}
\end{lyxcode}
\},~

\{

\textquotedbl{}cellphone\textquotedbl{}:\textquotedbl{}444-555-777\textquotedbl{},~

\textquotedbl{}db\_columns\textquotedbl{}:
\begin{lyxcode}
\{

\textquotedbl{}ce\_id\textquotedbl{}:4,~

\textquotedbl{}org\_id\textquotedbl{}:1

\},~
\end{lyxcode}
\textquotedbl{}email\textquotedbl{}:\textquotedbl{}zb@somewhere.unknown.org\textquotedbl{}

\}

{]}
\end{lyxcode}
\}
\end{lyxcode}
Because there can be several contact entity attribute sets associated
an \emph{org\_id} the \emph{attributes} JSON node contains an array.
If there are no attribute sets, the following JSON document is returned:
\begin{lyxcode}
\{

\textquotedbl{}attributes\textquotedbl{}:{[}{]}

\}
\end{lyxcode}

\subsection{/get/org\_contacts\_full?org\_id=positive integer}

This interface returns the full contact data for all contacts associated
with \emph{org\_id}, meaning it combines the data from \emph{/get/org\_contact}
and \emph{/get/org\_contact\_attributes}. Example JSON document:
\begin{quotation}
\{ 

\textquotedbl{}contacts\textquotedbl{}:{[} 
\begin{quotation}
\{

\textquotedbl{}attributes\textquotedbl{}: 
\begin{quotation}
\{

\textquotedbl{}cellphone\textquotedbl{}:\textquotedbl{}555-777-888-999\textquotedbl{}, 

\textquotedbl{}db\_columns\textquotedbl{}: 
\begin{quotation}
\{ 

\textquotedbl{}ce\_id\textquotedbl{}:1,

\textquotedbl{}org\_id\textquotedbl{}:1 

\}, 
\end{quotation}
\textquotedbl{}email\textquotedbl{}:\textquotedbl{}arthurdent42@somewhere.unknown.org\textquotedbl{},

\textquotedbl{}tags\textquotedbl{}:{[}
\begin{quotation}
\textquotedbl{}Traveller\textquotedbl{},

\textquotedbl{}Towel\textquotedbl{},

\textquotedbl{}Heart''

{]}
\end{quotation}
\}, 
\end{quotation}
\textquotedbl{}name\textquotedbl{}:\textquotedbl{}Arthur Dent\textquotedbl{},

\textquotedbl{}db\_columns\textquotedbl{}: 
\begin{quotation}
\{ 

\textquotedbl{}is\_human\textquotedbl{}:true, 

\textquotedbl{}ce\_id\textquotedbl{}:1, 

\textquotedbl{}ce\_name\textquotedbl{}:\textquotedbl{}Arthur Dent\textquotedbl{} 

\}, 
\end{quotation}
\textquotedbl{}type\textquotedbl{}:\textquotedbl{}human\textquotedbl{}

\}, 

\{ 

\textquotedbl{}attributes\textquotedbl{}: 
\begin{quotation}
\{ 

\textquotedbl{}cellphone\textquotedbl{}:\textquotedbl{}444-555-777\textquotedbl{}, 

\textquotedbl{}db\_columns\textquotedbl{}: 
\begin{quotation}
\{ 

\textquotedbl{}ce\_id\textquotedbl{}:4, 

\textquotedbl{}org\_id\textquotedbl{}:1

\}, 
\end{quotation}
\textquotedbl{}email\textquotedbl{}:\textquotedbl{}zb@somewhere.unknown.org\textquotedbl{} 

\}, 
\end{quotation}
\textquotedbl{}name\textquotedbl{}:\textquotedbl{}Zaphod B.\textquotedbl{}, 

\textquotedbl{}db\_columns\textquotedbl{}: 
\begin{quotation}
\{ 

\textquotedbl{}is\_human\textquotedbl{}:true, 

\textquotedbl{}ce\_id\textquotedbl{}:4, 

\textquotedbl{}ce\_name\textquotedbl{}:\textquotedbl{}Zaphod B.\textquotedbl{} 

\},
\end{quotation}
\textquotedbl{}type\textquotedbl{}:\textquotedbl{}human\textquotedbl{}

\}

{]} 
\end{quotation}
\}
\end{quotation}
If there are no contacts associated with \emph{org\_id} the following
JSON document is returned:
\begin{lyxcode}
\{

\textquotedbl{}contacts\textquotedbl{}:{[}{]}

\}
\end{lyxcode}

\subsection{/get/queue}

This interface returns the current call queue. This is updated once
each second, so polling the /get/queue interface more often than once
each second is both wasteful and pointless. Calling for example:
\begin{lyxcode}
/get/queue
\end{lyxcode}
will return a JSON string like this:
\begin{lyxcode}
\{

\textquotedbl{}normal\textquotedbl{}:{[}
\begin{lyxcode}
\{

\textquotedbl{}UTC\_start\_date\textquotedbl{}:\textquotedbl{}2012-02-22~14:23:30\textquotedbl{},

\textquotedbl{}id\textquotedbl{}:\textquotedbl{}GDhcf2VBww\textquotedbl{},

\textquotedbl{}unix\_timestamp\textquotedbl{}:\textquotedbl{}1329920610\textquotedbl{},

\textquotedbl{}callee\textquotedbl{}:5,

\textquotedbl{}caller\textquotedbl{}:\textquotedbl{}d7sIp1kR\textquotedbl{}

\}

{]},
\end{lyxcode}
\textquotedbl{}high\textquotedbl{}:{[}
\begin{lyxcode}
\{

\textquotedbl{}UTC\_start\_date\textquotedbl{}:\textquotedbl{}2012-02-22~14:23:11\textquotedbl{},

\textquotedbl{}id\textquotedbl{}:\textquotedbl{}bRbYsMUVqx\textquotedbl{},

\textquotedbl{}unix\_timestamp\textquotedbl{}:\textquotedbl{}1329920591\textquotedbl{},

\textquotedbl{}callee\textquotedbl{}:3,

\textquotedbl{}caller\textquotedbl{}:\textquotedbl{}oCgDF7ua\textquotedbl{}

\}

{]},
\end{lyxcode}
\textquotedbl{}low\textquotedbl{}:{[}
\begin{lyxcode}
\{

\textquotedbl{}UTC\_start\_date\textquotedbl{}:\textquotedbl{}2012-02-22~14:23:17\textquotedbl{},

\textquotedbl{}id\textquotedbl{}:\textquotedbl{}VV8BFqGpqG\textquotedbl{},

\textquotedbl{}unix\_timestamp\textquotedbl{}:\textquotedbl{}1329920597\textquotedbl{},

\textquotedbl{}callee\textquotedbl{}:9,

\textquotedbl{}caller\textquotedbl{}:\textquotedbl{}ZQsRogwB\textquotedbl{}

\}

{]},
\end{lyxcode}
``length'':3

\}
\end{lyxcode}
The \emph{normal}, \emph{low} and \emph{high} nodes represent priority
in the queue. All these naturally contains arrays of calls. The \emph{length}
node contains the totalt length of the queue. The\emph{ callee} node
maps to an \emph{org\_id}. An empty queue returns the following JSON
document:
\begin{lyxcode}
\{

\textquotedbl{}normal\textquotedbl{}:{[}{]},~

\textquotedbl{}length\textquotedbl{}:0,~

\textquotedbl{}high\textquotedbl{}:{[}{]},~

\textquotedbl{}low\textquotedbl{}:{[}{]}

\}
\end{lyxcode}

\subsection{/get/queue\_length}

This interface returns the length of the current call queue. Example
JSON document:
\begin{lyxcode}
\{

\textquotedbl{}length\textquotedbl{}:7

\}\end{lyxcode}

\end{document}
